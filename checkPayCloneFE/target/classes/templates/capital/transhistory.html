<!DOCTYPE html>
<html lang="ko" class="leaf">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no">
<title>CheckPay</title>
<meta http-equiv="Cache-Control" content="No-Cache">
<meta http-equiv="Pragma" content="No-Cache">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<!--<meta name="title" content="">-->
<meta name="description" content="">
<!--<meta name="keywords" content="">-->
<!-- The Open Graph protocol -->
<meta property="og:type" content="website">
<meta property="og:title" content="">
<meta property="og:description" content="">
<meta property="og:url" content="">
<meta property="og:image" content=""><!-- [D]리얼경로로 변경하세요 -->
<!-- //The Open Graph protocol -->
<link rel="SHORTCUT ICON" href=""><!-- [D]리얼경로로 변경하세요 -->
<link rel="stylesheet" type="text/css" href="../../css/jquery-ui.min.css">
<link rel="stylesheet" type="text/css" href="../../css/reset.css">
<link rel="stylesheet" type="text/css" href="../../css/content.css">
<link rel="stylesheet" type="text/css" href="../../css/theme_checkpay.css">
<script type="text/javascript" src="../../js/jquery-1.8.3.min.js"></script>
<script type="text/javascript" src="../../js/jquery-ui.min.js"></script>
<script type="text/javascript" src="../../js/jquery.ui.touch-punch.min.js"></script>
<script type="text/javascript" src="../../js/slide_slick.js"></script>
<script type="text/javascript" src="../../js/publishing.ui.library.1.0.0.js"></script>
<script type="text/javascript" src="../../js/cmd.js"></script>
<script type="text/javascript" src="../../js/common.js"></script>
</head>

<body>
<!-- wrap -->
<div class="wrap">

	<!-- header -->
	<div class="header">
		<div class="header_inn">
			<div class="left">
				<a href="javascript:history.back();" class="btnBack"><span class="blind">Back</span></a>
			</div>
			<div class="right">
<!--                <a href="#none" class="btnClose"><span class="blind">close</span></a>-->
			</div>
		</div>
	</div>
	<!-- //header -->

	<!-- container -->
	<div class="container">
		<div class="content">
<!--			<div class="topErrPop">-->
<!--				<p class="tx">부산은행 업데이트 오류입니다. <br>-->
<!--					잠시 후 다시 업데이트해 주세요.</p>-->
<!--			</div>-->
			<div class="tBalance">
				
				<!-- 새로고침중 일때 class에 ing 추가 -->
				<!-- <a href="#" class="btnRef ing"><span class="blind">새로고침</span></a> -->
			</div>
			<div class="accHistory">
				<div class="topCtrl">
					<div class="rangeCtrl">
						<button class="btnPrev"><span class="blind">이전</span></button>
						<span class="range">2021년</span>
						<button class="btnNext"><span class="blind">다음</span></button>
					</div>
					<a href="#layerFilter" class="btnFilter btn_open_bottom_sheet" role="button"><span class="blind">필터</span></a>
				</div>
				<div class="historyList">
					<div class="upLoading circleBar">
						<div class="loader"></div>
						<p>업데이트 중입니다</p>
					</div>
				</div>
			</div>
		</div>
	</div>
	<!-- //container -->

</div>
<!-- //wrap -->
<div id="layerFilter" class="layer_bottomsheet" >
	<div class="layer_inner">
		<div class="layer_tit">
			<strong class="tit"><span class="blind">조회조건선택팝업</span></strong>
			<button type="button" class="js_pop_close btn_close"><span class="blind">닫기</span></button>
		</div>
		<div class="layer_cont">
           <div class="filterItem">
			   <p class="filterTit">조회기간</p>
				<ul class="radioTab">
					<li>
						<input type="radio" id="radio1" name="radioTab1" class="blind">
						<label for="radio1">1개월</label>
					</li>
					<li>
						<input type="radio" id="radio2" name="radioTab1" class="blind">
						<label for="radio2">3개월</label>
					</li>
					<li>
						<input type="radio" id="radio3" name="radioTab1" class="blind">
						<label for="radio3">6개월</label>
					</li>
					<li>
						<input type="radio" id="radio4" name="radioTab1" class="blind">
						<label for="radio4">직접입력</label>
					</li>
				</ul>
				<div class="selPeriod">
					<!-- datepicker data-title 추가 -->
					<!-- 21.08.31 수정 -->
					<div class="dateItem">
						<label for="startDate" class="blind">조회기간 시작일</label>
						<input type="tel" class="datepicker" id="startDate" autocomplete="off" data-title="시작일" placeholder="YYYY.MM.DD">
					</div>
					<span class="unit">-</span>
					<div class="dateItem">
						<label for="endDate" class="blind">조회기간 종료일</label>
						<input type="tel" id="endDate" class="datepicker" autocomplete="off" data-title="종료일" placeholder="YYYY.MM.DD">
					</div>
				</div>
		   </div>
			<div class="filterItem">
				<p class="filterTit">정렬순</p>
				<ul class="radioTab">
					<li>
						<input type="radio" id="radio8" name="radioTab3" class="blind">
						<label for="radio8">최신순</label>
					</li>
					<li>
						<input type="radio" id="radio9" name="radioTab3" class="blind">
						<label for="radio9">과거순</label>
					</li>
				</ul>
			</div>
		</div>
		<div class="layer_footer">
			<button type="button" class="js_pop_close btn_confirm"><span>확인</span></button>
		</div>
	</div>
</div>

<!-- [S] layer E1120 내용 -->
<div id="layer_E1120" class="layer_bottomsheet">
	<div class="layer_inner">
		<div class="layer_tit">
			<strong class="tit"><span>대출 거래 상세</span></strong>
			<button type="button" class="js_pop_close btn_close"><span class="blind">닫기</span></button>
		</div>
		<div class="layer_cont">
			<!-- [S] E1120 -->
			<div class="accSetting type_history">
				
			</div>
			<!-- [E] E1120 -->
		</div>
	</div>
</div>
<!-- [E] layer E1120 내용 -->

<script>
	var isLoad=false; //ajax 중복호출방지 호출 중?
	// 업데이트 페이지 보여주기
	$(function(){
		$('.upLoading').hide();	// 업데이트 애니메이션
		$('.toastMsg').hide();	// 업데이트 완료 modal
		$(window).scroll(function(){	// 스크롤 마지막일 경우 데이터 가져오기
			// let $window = $(this);
			let scrollTop = $(this).scrollTop();
			let windowHeight = $(this).height();
			let documentHeight = $(document).height();
			// scrollbar의 thumb가 바닥 전 30px까지 도달 하면 리스트를 가져온다.
			if( scrollTop + windowHeight + 30 > documentHeight && !isLoad ){
				capitaltransList(true,now_start, now_end,sort);
			}
		});
	});
	var msg='';		// 같은 날인지 확인하기 위해 전역변수선언
	var isEnd=false; // 스크롤 내렸을 때 업데이트할 데이터가 있는지 유무 판단
	var offset=0;	// 업데이트할 데이터 페이지 구분
	var sort ='desc';	// 최신순, 과거순

	var token = getCookie("jwt");
	var memb_cd=parseJwt(getCookie("jwt")).sub;
	var account_num='[[${account_num}]]';
	var org_code='[[${org_code}]]';
	// 리스트 날짜별로 담을 Map
	var dateMap= new Map();
	
	
	// 날짜 디폴트값 현재년 1일부터 마지막날까지
	var date = new Date();
	var now_start = new Date(date.getFullYear(),0, 1);
	var now_end = new Date(date.getFullYear(), 11, 31);
	
	capitaltransList(true ,now_start,now_end,sort);
	// 새로고침 클릭 시 데이터 새로 받아오기
	$(document).on("click", ".btnRef", function(e){
		capitaltransList(true ,now_start,now_end,sort);
		dateMap= new Map();
		offset-=10;
        // api 불러오는 함수 적기
	});


	//상단 프린트
	var topdata="";
	topdata+='<h3 class="tBaltit">'+'[[${prod_name}]]'+'</h3>';
	topdata+='<p class="tBalDetail">'+'[[${org_name}]]'+' '+'[[${account_num}]]'+'</p>';
	topdata+='<a href="#" class="btnRef"><span class="blind">새로고침</span></a>';
	
	$('.tBalance').html(topdata);


// [S] 바텀시트
$(document).on("click", ".btn_open_bottom_sheet", function(e){
	e.preventDefault();
	var $href = $(this).attr('href');
	layer_bottomsheet($href);
	$('html').addClass('scroll_lock');
	// [S] multi layer
	var dimIdx = $('.dim').index();
	eval('$focusReturn' + [dimIdx] + '= $(this)');
	// [E] multi layer
});
function layer_bottomsheet(el){
	var $el = $(el);
	$el.append("<div class=\"dim\"></div>");
	isDim ? $('.layer_bottomsheet').show() : $el.show().attr({'tabindex':'0','aria-hidden':'false'}).focus();
	setTimeout(function() {
		$el.find('.layer_inner').addClass('on');
	}, 50);
	// [S] multi layer
	var isDim;
	var dimIdx = $('.dim').index();
	var thisDim = $el.find('.dim');
	var thisLyZindex = dimIdx + 4000;
	$('.dim').css('opacity','0');
	thisDim.css('opacity','.7');
	thisDim.closest('.layer_bottomsheet, .layer_popup').css('z-index', thisLyZindex);
	// [E] multi layer
	$el.find('.js_pop_close').click(function(){
		$el.find('.layer_inner').removeClass('on');
		setTimeout(function() {
			isDim ? $('.layer_bottomsheet').hide() : $el.hide();
			$('html').removeClass('scroll_lock');
			$el.attr({'tabindex':'-1','aria-hidden':'true'}).find(".dim").remove();
			// [S] multi layer
			if($('.dim').length == '2'){
				$('.dim:eq(1)').css('opacity','.7');
			}else if($('.dim').length == '1'){
				$('.dim').css('opacity','.7');
			}
			// [E] multi layer
		}, 200);
		eval('$focusReturn'+ [dimIdx]).focus();
		return false;
	});
}
// [E] 바텀시트


// 업데이트중 문구 안보이게하고 업데이트완료 문구 2초동안 띄우기
function toastMsgShow(){	
	$('.toastMsg').show();
	setTimeout(function(){
		$('.toastMsg').hide();
	},2000);
}


// [S] moddal 창 값 넘겨주기
function layer_cont(trans_type,trans_dtime1,trans_dtime2,trans_amt,principal_amt,int_amt,ret_int_amt,int_rate,int_start_date,int_end_date,currency_code){
	var detailHtml="";
	var isKrw = currency_code=="KRW"?'원':currency_code;
	var int_startDate=int_start_date.substr(2, 2) + '-' + int_start_date.substr(4, 2) + '-' + int_start_date.substr(6, 2);	
	var int_endDate=int_end_date.substr(2, 2) + '-' + int_end_date.substr(4, 2) + '-' + int_end_date.substr(6, 2);
	detailHtml+='<div class="tAccount">';
	detailHtml+='<h3 class="tAccTit">'+trans_type+'</h3>';
	detailHtml+='<p class="tAccDetail">'+trans_dtime1+'</p>';
	detailHtml+='</div>';
	detailHtml+='<h4 class="listTit"><em class="pointColor">요약</em></h4>';
	detailHtml+='<ul class="accDetailList">';
	detailHtml+='<li>';
	detailHtml+='<span class="itemTit">일시</span>';
	detailHtml+='<span class="itemData"><span class="num">'+trans_dtime2+'</span></span>';
	detailHtml+='</li>';
	detailHtml+='<li>';
	detailHtml+='<span class="itemTit">금액</span>';
	detailHtml+='<span class="itemData"><span class="num">'+trans_amt.toLocaleString()+'</span>'+isKrw+'</span>';
	detailHtml+='</li>';
	detailHtml+='<li>';
	detailHtml+='<span class="itemTit">금액 중 원금</span>';
	detailHtml+='<span class="itemData"><span class="num">'+principal_amt.toLocaleString()+'</span>'+isKrw+'</span>';
	detailHtml+='</li>';
	detailHtml+='</ul>';
	detailHtml+='<ul class="accDetailList">';
	detailHtml+='<li>';
	detailHtml+='<span class="itemTit"><em class="pointColor">금액 중 이자</em></span>';
	detailHtml+='<span class="itemData"><span class="num">'+int_amt.toLocaleString()+'</span>'+isKrw+'</span>';
	detailHtml+='</li>';
	detailHtml+='<li>';
	detailHtml+='<span class="itemTit">환출이자</span>';
	detailHtml+='<span class="itemData"><span class="num">'+ret_int_amt.toLocaleString()+'</span>'+isKrw+'</span>';
	detailHtml+='</li>';
	detailHtml+='<li>';
	detailHtml+='<span class="itemTit">정상이자</span>';
	detailHtml+='<span class="itemData">';
	detailHtml+='<span class="num">'+(trans_amt*int_rate/100).toLocaleString()+'</span>'+isKrw+'';
	detailHtml+='</span>';
	detailHtml+='<span class="dataSubTxt">이자율 '+int_rate+'%</span>';
	detailHtml+='<span class="dataSubTxt">이자 적용 기간 ('+int_startDate+'~'+int_endDate+')</span>';
	detailHtml+='</li>';
	detailHtml+='</ul>';
	$('.accSetting').empty();
	$('.accSetting').append(detailHtml);
}
// [E] moddal 창 값 넘겨주기

// 리스트 찍을 List
function printCapList(){
	var hisList="";
	// MM:dd O요일을 key로 받고 해당 날에 이체(?)내역을 val로 받는 Map
	dateMap.forEach((mapVal, mapKey)=>{
		hisList+='<span class="date"><span class="num">'+mapKey+'</span> '+toKor_dayOfWeek(new Date(mapVal[0].trans_dtime).getDay())+'</span>';
		hisList+='<ul>';
		mapVal.forEach((arrVal,arrIdx)=>{
			hisList+='<li>';
			hisList+='<a onclick="javascript:layer_cont(\''+arrVal.trans_type+'\',\''
						+hours_minute_col(new Date(arrVal.trans_dtime))+'\',\''
						+year_month_date_hours_min(new Date(arrVal.trans_dtime))+'\','
						+arrVal.trans_amt+','
						+arrVal.principal_amt+','
						+arrVal.int_amt+','
						+arrVal.ret_int_amt+','
						+arrVal.int_rate+',\''
						+arrVal.int_start_date+'\',\''
						+arrVal.int_end_date+'\',\''
						+arrVal.currency_code+'\');"  href="#layer_E1120" class="link btn_open_bottom_sheet" role="button" >';
			hisList+='<div class="left">';
			hisList+='<span class="category">'+arrVal.trans_type+'</span>';
			hisList+='<span class="time">'+hours_minute_col(new Date(mapVal[0].trans_dtime))+'</span>';
			hisList+='</div>';
			hisList+='<div class="right">';
			if(arrVal.currency_code=="KRW"){
			hisList+='<span class="amount"><em class="num">'+arrVal.trans_amt.toLocaleString()+'</em>원</span>';
			hisList+='<span class="balance">잔액 <em class="num">'+arrVal.balance_amt.toLocaleString()+'</em>원</span>';
			hisList+='<span class="balance">이자 <em class="num">'+arrVal.int_amt.toLocaleString()+'</em>원</span>';
			}else{
			hisList+='<span class="amount"><em class="num">'+arrVal.trans_amt.toLocaleString()+'</em>'+arrVal.currency_code+'</span>';
			hisList+='<span class="balance">잔액 <em class="num">'+arrVal.balance_amt.toLocaleString()+'</em>'+arrVal.currency_code+'</span>';
			hisList+='<span class="balance">이자 <em class="num">'+arrVal.int_amt.toLocaleString()+'</em>'+arrVal.currency_code+'</span>';
			}
			hisList+='</div>';
			hisList+='</a>';
			hisList+='</li>';
		});
		hisList+='</ul>';
	});
	$('.historyList').html(hisList);
	
	isLoad=false;	//호출 끝!
}

// api 호출 및 해당 거래내역 조회
function capitaltransList(isBtnRef,start_day, end_day, sort){
	isEnd=false;
	isLoad=true;
	$.ajax({
		url:'http://192.168.240.208:8081/api/capital/capitaltransdetail/'+memb_cd+'/'+org_code+'/'+account_num+'/'+year_month_date_dash(start_day)+'/'+year_month_date_dash(end_day)+'/'+sort+'/'+offset,
		dataType: 'json',
		contentType : 'application/json',
		beforeSend:function(xhr){	// ajax 요청하기전에 실행
			$('.upLoading').show();
			if(isBtnRef==true){
				$('.btnRef').addClass("ing");
			}
        	xhr.setRequestHeader("Authorization", "Bearer "+token);
		},
		//[S]success
		
		success:function(data){
			let arrUl = '';
			let isData=false;
			if(data.length == 0 && dateMap.size==0){	// 데이터가 없는 경우
				arrUl += '<p class="listNone">불러올 내역이 없습니다.</p>';
				$('.historyList').html(arrUl);
				return;
			}
			$(data).each((index, item)=>{
				
				var date = month_date_dot(new Date(item.trans_dtime));
				var dateForArr=dateMap.get(date)==null?new Array():dateMap.get(date);
					if(dateMap.get(date)!=null){
						dateForArr[dateForArr.length]=item;
						dateMap.set(date, dateForArr);
					}
					else{
						dateForArr[0]=item;
						dateMap.set(date, dateForArr);
					}
			});
			printCapList(dateMap);
			offset+=10;
		},//[E]success
		error: function (jqXHR) {
			if (jqXHR.status == 401 && jqXHR.responseText=="토큰 기한 만료") {
				tokenCall2();
			}
    	},
		complete : function(xhr, status) {	// ajax 응답 완료시 오류,성공 상관없이 호출됨
	    // success와 error 콜백이 호출된 후에 반드시 호출, try - catch - finally의 finally 구문과 동일
			$('.upLoading').hide();
			if(isBtnRef==true){
				$('.btnRef').removeClass("ing");
				toastMsgShow();
				isBtnRef=false;
			}
		}
	});
}
$(document).ready(()=>{
	// [S] 날짜 이벤트 코드
	let today = new Date();
	let year = today.getFullYear();
	let count = 0;
	$(".range").eq(0).text(year+'년');	// 올해 텍스트 셋팅
	$(".btnPrev").click(function(){ // 이전 버튼
		$('.historyList').html(''); 
		offset=0;
		dateMap= new Map();
		today = new Date();    //현재날짜
		count = count +1;      //현재 카운트 에서 +1
		let nowday=today.getFullYear()-count
		$(".range").eq(0).text(nowday+'년');
		// api 불러서 거래내역 보여주는 함수
		now_start= new Date(nowday, '00','01');
		now_end= new Date(nowday, '11','31');
		capitaltransList(false, now_start, now_end, sort);
	});
   $(".btnNext").click(function(e){ // 다음 버튼
		dateMap= new Map();
		offset=0;
	  	today = new Date();
	  	count = count -1;
      	let nowday=today.getFullYear()-count
      	if(Number(today.getFullYear()<(today.getFullYear()-count))){// 현재날짜보다 앞선다면 초기화 및 이동 금지
        	count=0;
         	return false;
      	}
      	$(".range").eq(0).text(nowday+'년');
      	// api 불러서 거래내역 보여주는 함수
		now_start= new Date(nowday, '00','01');
		now_end= new Date(nowday, '11','31');
  		capitaltransList(false, now_start, now_end, sort);
   });
	// [E] 날짜 이벤트 코드
	
	
// [S] 1,3,6 개월 조회기간 값 변환
	$('input:radio[id="radio1"]').change(function(){
		var date_1 = minusMonth(today,1)
		year = date_1.getFullYear();
		month = ('0' + (date_1.getMonth()+1)).slice(-2);
		date = ('0' + (date_1.getDate())).slice(-2);
		dateString =  year + '.' + month + '.' + date;
		$('#startDate').val(dateString);
	});
	$('input:radio[id="radio2"]').change(function(){
		var date_3 = minusMonth(today,3)
		year = date_3.getFullYear();
		month = ('0' + (date_3.getMonth()+1)).slice(-2);
		date = ('0' + (date_3.getDate())).slice(-2);
		dateString =  year + '.' + month + '.' + date;
		$('#startDate').val(dateString);
	});
	$('input:radio[id="radio3"]').change(function(){
		var date_6 = minusMonth(today,6)
		year = date_6.getFullYear();
		month = ('0' + (date_6.getMonth()+1)).slice(-2);
		date = ('0' + (date_6.getDate())).slice(-2);
		dateString =  year + '.' + month + '.' + date;
		$('#startDate').val(dateString);
	});
	// [E] 개월 수 별로 이벤트 구현 코드

	// [S] 디폴트(직접입력, 전체, 최신순)
	$('#radio4').trigger("click");
	$('#radio5').trigger("click");
	// [N] 디폴트 작업

	// [S] 달력을 클릭시 '직접입력'으로 전환
	$(".ui-datepicker-trigger").click(function(){
		$('#radio4').trigger("click");
	}); 
	// [N] 달력을 클릭시 '직접입력'으로 전환

	// [S] 최신순, 과거순 클릭시 정렬순서값 설정
	$('#radio8').click(function(){
		sort = "desc";
	});
	$('#radio9').click(function(){
		sort = "asc";
	});
	$('#radio8').trigger("click");
	// [E] 최신순, 과거순 클릭시 정렬순서값 설정

	// [S] 필터 이벤트 코드 : (필터 이벤트 영역)
	$(".btn_confirm").click(function(){
		offset=0;
		dateMap= new Map();
		$('.btnPrev').hide(); // 날짜 왼쪽 화살표 숨기기
		$('.btnNext').hide(); // 날짜 오른쪽 화살표 숨기기
		$('.btnFilter').hide(); // 필터 색없는거 숨기기

		// 필터 색 있는거 생성
		$('.topCtrl').append("<a href='#layerFilter' class='btnFilter on btn_open_bottom_sheet' role='button'><span class='blind'>"+"필터"+"</span></a>");

		// 시작일, 종료일 값 불러오기
		var startDate = $('#startDate').val().slice(2); 
		var endDate = $('#endDate').val().slice(2);
		var dateString =  startDate + '~' + endDate;
		$(".range").html(dateString);

		let startDate2 = $('#startDate').val();
		let endDate2 = $('#endDate').val();
		now_start = new Date(startDate2.replaceAll('.', '-'));
		now_end = new Date(endDate2.replaceAll('.', '-'));
		
		// api 처리하기
		capitaltransList(false, now_start, now_end,sort);
		
		// 탭 분류 , 검색은 비동기로 하자, 정렬
	});
	// [E] 필터 이벤트 코드
	
		// [S] 개월 수 (윤년 포함) 계산 함수
	function minusMonth(date, month) {
		// month달 후의 1일
		let addMonthFirstDate = new Date(date.getFullYear(),date.getMonth() - month, 1);
		// month달 후의 말일
		let addMonthLastDate = new Date(addMonthFirstDate.getFullYear(),addMonthFirstDate.getMonth() + 1, 0);
		let result = addMonthFirstDate;
		if(date.getDate() > addMonthLastDate.getDate()) {
			result.setDate(addMonthLastDate.getDate());
		} else {
			result.setDate(date.getDate());
		}
		return result;
	}
	// [E] 개월 수 계산 함수
});


</script>

</body>
</html>